<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Reserva Única</title>
	<link href="assets/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link rel="preconnect" href="https://fonts.gstatic.com">
	<link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
	<link href="assets/css/style.css" rel="stylesheet" type="text/css">
</head>

<body>
	<div class="admin">
		<header class="admin__header">
			<div class="dropdown-primary dropdown">
				<a class="nav-link dropdown-toggle menu-action" href="#" id="userMenu" role="button"
					data-bs-toggle="dropdown" aria-expanded="false"><img class="avatar img-responsive"
						src="assets/img/avatar.png" alt="avatar"> Olá, Tássio!</a>
				<ul class="dropdown-menu" aria-labelledby="userMenu">
					<li>
						<a class="dropdown-item" href="#">Meus Dados</a>
					</li>
					<li>
						<a class="dropdown-item" href="#">Sair</a>
					</li>
				</ul>
			</div>
			<a href="/" class="mr-5">
				<h2>Reserva<b>Canto</b></h2>
			</a>
			<button class="btn btn-link menu-action mr-3" title="Agendar reserva">
				<i class="far fa-bell has-activity"></i>
			</button>
		</header>
		<main class="admin__main">
			<div class="container">
				<div class="painel">
					<div class="content w-100">
						<canvas id="viewport"></canvas>
					</div>
					<button class="btn mt-1" onclick="showLogs()">Logs</button>
				</div>
				<div id="log" class="log-painel mt-5" style="display: none;">
					<button onclick="clearLog()" id="clearBtn" class="btn btn-secondary btn-action"><i
							class="fas fa-trash"></i> Limpar</button>
				</div>
			</div>
		</main>
	</div>
	
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"
		integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
	<script src="assets/bootstrap/js/bootstrap.min.js">
	</script>
	<script src="https://kit.fontawesome.com/4a72eb39d8.js" crossorigin="anonymous"></script>
	<script src="assets/js/fabric.min.js"></script>
	<script>
		
		//variáveis
		const STEP = 1;

        var Direction = {
            LEFT: 0,
            UP: 1,
            RIGHT: 2,
            DOWN: 3
        };
		
		//criando o canvas
		var canvas = this.__canvas = new fabric.Canvas('viewport', {
			height: 539,
			width: 958
		});

		fabric.Object.prototype.setControlsVisibility({
			mtr: false,
			mt: false, // middle top 
			mb: false, // midle bottom
			ml: false, // middle left
			mr: false, // middle right
			tl: true, //top left
			tr: true, //top right
			bl: true, //bottom left
			br: true //bottom right
		});

		var deleteImg = document.createElement('img');
		deleteImg.src = "data:image/svg+xml,%3C%3Fxml version='1.0' encoding='utf-8'%3F%3E%3C!DOCTYPE svg PUBLIC '-//W3C//DTD SVG 1.1//EN' 'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'%3E%3Csvg version='1.1' id='Ebene_1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' width='595.275px' height='595.275px' viewBox='200 215 230 470' xml:space='preserve'%3E%3Ccircle style='fill:%23F44336;' cx='299.76' cy='439.067' r='218.516'/%3E%3Cg%3E%3Crect x='267.162' y='307.978' transform='matrix(0.7071 -0.7071 0.7071 0.7071 -222.6202 340.6915)' style='fill:white;' width='65.545' height='262.18'/%3E%3Crect x='266.988' y='308.153' transform='matrix(0.7071 0.7071 -0.7071 0.7071 398.3889 -83.3116)' style='fill:white;' width='65.544' height='262.179'/%3E%3C/g%3E%3C/svg%3E";

		var center = new fabric.Rect({
			left: 0,
			top: 0,
			width: 1,
			height: 1,
			fill: 'transparent',
		});
		canvas.add(center)
		canvas.centerObject(center);

		/*INICIO ADIÇÃO DE EVENTOS AO CANVAS*/
		// Diminui a opacidade da mesa ao passar mouse
		canvas.on('mouse:over', function (e) {
			if (!e || !e.target) return;

			e.target.set('opacity', 0.5);
			canvas.renderAll();
		});

		// Volta a opacidade da mesa ao sair
		canvas.on('mouse:out', function (e) {
			if (!e || !e.target) return;
			
			e.target.set('opacity', 1);
			canvas.renderAll();
		});

		// Adiciona nova mesa
		canvas.on('mouse:dblclick', function (options) {
			//log('mouse:dblclick', options);

			if (options && options.target) return;

			var circle = new fabric.Circle({
				radius: 10,
				left: options.absolutePointer.x - 10,
				top: options.absolutePointer.y - 10,
			});
			
			canvas.add(circle);
			canvas.setActiveObject(circle);
			canvas.renderAll();
		});

		// canvas.on('object:moved', function (options) {
		// 	//log('object:moved', options);
		// 	editChair(canvas.getActiveObject().get("type") == "activeSelection");
		// });

		// canvas.on({
		// 	'object:scaled': function (opt) { log('object:scaled', opt) },
		// });
		

		/*FIM ADIÇÃO DE EVENTOS AO CANVAS*/

		//criando evento para mover objetos selecionados pelo teclado
		window.fabric.util.addListener(document.body, 'keydown', function (options) {
            if (options.repeat)  return;
			
            var key = options.which || options.keyCode; // key detection
            if (key === 37) { // handle Left key
                onMoveSelected(Direction.LEFT);
            } else if (key === 38) { // handle Up key
                onMoveSelected(Direction.UP);
            } else if (key === 39) { // handle Right key
                onMoveSelected(Direction.RIGHT);
            } else if (key === 40) { // handle Down key
                onMoveSelected(Direction.DOWN);
            } else if (event.ctrlKey && key === 67) {//Copy - CTRL+C
				copy();
			} else if (event.ctrlKey && key === 86) { //Paste - CTRL+V
				Paste();
			} if(key === 46){ //Delete
				//deleteChair(canvas);
			}
        });

		//Método utilizado para mover os objetos
		function onMoveSelected(direction) {
            var activeObject = canvas.getActiveObject();

            if (activeObject != null) {
                switch (direction) {
                    case Direction.LEFT: activeObject.set("left", activeObject.get("left") - STEP);break;
                    case Direction.UP: activeObject.set("top", activeObject.get("top") - STEP); break;
                    case Direction.RIGHT: activeObject.set("left", activeObject.get("left") + STEP); break;
                    case Direction.DOWN: activeObject.set("top", activeObject.get("top") + STEP); break;
                }
                activeObject.setCoords();
                canvas.renderAll();
            }
        }


	
		// TODO: redimensionar a imagem para um tamanho mínimo.
		function resizeCanvas() {
			const outerCanvasContainer = $('.content')[0];

			const ratio = canvas.getWidth() / canvas.getHeight();
			const containerWidth = outerCanvasContainer.clientWidth;
			const containerHeight = outerCanvasContainer.clientHeight;

			const scale = containerWidth / canvas.getWidth();
			const zoom = canvas.getZoom() * scale;
			canvas.setDimensions({
				width: containerWidth,
				height: containerWidth / ratio
			});
			canvas.setViewportTransform([zoom, 0, 0, zoom, 0, 0]);
		}

		$(window).resize(resizeCanvas);
		
		

		// Baixa a imagem do canvas
		function downloadImage() {
			var link = document.createElement('a');
			link.innerHTML = 'Baixar Imagem';
			link.addEventListener('click', function (ev) {
				link.href = canvas.toDataURL();
				link.download = "planta.png";
			}, false);
			document.body.appendChild(link);
			link.click();
		}

	</script>
</body>

</html>